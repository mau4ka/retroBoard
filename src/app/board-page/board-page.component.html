<header class="header">
  <h1 class="pointer" routerLink="/">RetroBoard</h1>
  <div class="header-buttons">
    <button (click)="newTaskBox = !newTaskBox" class="plus-button">
      &#10010; task
    </button>
    <button (click)="newColumnBox = !newColumnBox" class="plus-button">
      &#10010; column
    </button>
    <button *ngIf="loadingEnd" (click)="exportexcel()" class="plus-button">
      Download board
    </button>

    <img
      (click)="catIcon = !catIcon"
      class="cat-icon pointer"
      src="../../assets/catIcon.png"
      alt=""
    />
    <div *ngIf="catIcon" class="log-out">
      <p>
        {{ userName }}
        <span class="pointer" (click)="catIcon = !catIcon">&#10006;</span>
      </p>
      <p class="log" (click)="logOut()">LogOut</p>
    </div>
  </div>
</header>

<app-alert></app-alert>

<div class="alert alert-danger" *ngIf="auth.error$ | async as error">
  {{ error }}
</div>

<form
  *ngIf="newTaskBox"
  class="add-task-form"
  [formGroup]="form"
  (ngSubmit)="addTask()"
>
  <div>
    <input
      class="plus-input"
      type="text"
      formControlName="text"
      placeholder="Enter task"
    />
    <div
      class="validation"
      *ngIf="form.get('text')!.touched && form.get('text')!.invalid"
    >
      <small *ngIf="form.get('text')!.errors!['required']"> Enter task </small>
      <small *ngIf="form.get('text')!.errors!['minlength']">
        Task is too short. It must be at least
        {{ form.get("text")!.errors!["minlength"]!["requiredLength"] }}, now
        {{ form.get("text")!.errors!["minlength"]!["actualLength"] }}
      </small>
    </div>
  </div>

  <p>Column</p>
  <select class="plus-select" value="" formControlName="column">
    <option *ngFor="let task of tasks" value="{{ task._id }}">
      {{ task.name }}
    </option>
  </select>
  <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
    Add
  </button>
</form>

<form
  *ngIf="newColumnBox"
  class="add-task-form"
  [formGroup]="formColumn"
  (ngSubmit)="addColumn()"
>
  <div>
    <input
      class="plus-input"
      type="text"
      formControlName="columnName"
      placeholder="Enter column name"
    />
    <div
      class="validation"
      *ngIf="
        formColumn.get('columnName')!.touched &&
        formColumn.get('columnName')!.invalid
      "
    >
      <small *ngIf="formColumn.get('columnName')!.errors!['required']">
        Enter column name
      </small>
      <small *ngIf="formColumn.get('columnName')!.errors!['minlength']">
        Column name is too short. It must be at least
        {{
          formColumn.get("columnName")!.errors!["minlength"]!["requiredLength"]
        }}, now
        {{
          formColumn.get("columnName")!.errors!["minlength"]!["actualLength"]
        }}
      </small>
    </div>
  </div>

  <button type="submit" class="btn btn-primary" [disabled]="formColumn.invalid">
    Add
  </button>
</form>

<ng-template #load>
  <app-preloader></app-preloader>
</ng-template>

<div class="none">
  <table id="excel-table">
    <tbody>
      <tr>
        <th>Block #</th>
        <th>Block name</th>
        <th>Tasks...</th>
      </tr>
      <tr *ngFor="let task of tasks; let i = index">
        <th>{{ i + 1 }}</th>
        <td>{{ task.name }}</td>
        <td *ngFor="let item of task.tasks">{{ item.text }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="loadingEnd; else load" class="board-container">
  <div cdkDropListGroup class="board">
    <div class="example-container" *ngFor="let task of tasks">
      <h2 class="center">{{ task.name }}</h2>

      <div
        cdkDropList
        [cdkDropListData]="task.tasks"
        class="example-list"
        (cdkDropListDropped)="drop($event, task.name)"
        id="{{ task._id }}"
      >
        <div class="example-box" *ngFor="let item of task.tasks" cdkDrag>
          {{ item.text }} <br />
          <p>Auhor: {{ item.author }}</p>
          <div>
            <p>
              {{ item.likes?.length }}
              <span
                (click)="addLike(task._id || '', item._id || '')"
                class="heart"
                [ngClass]="heartType(item)"
                >&#10084;</span
              >
              <span (click)="showComm(item._id || '')" class="pointer">
                {{ item.comments?.length }}

                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20px"
                  height="20px"
                  viewBox="0 0 48 48"
                  fill="none"
                >
                  <rect
                    width="48"
                    height="48"
                    fill="white"
                    fill-opacity="0.01"
                  />
                  <path
                    d="M44 24C44 35.0457 35.0457 44 24 44C18.0265 44 4 44 4 44C4 44 4 29.0722 4 24C4 12.9543 12.9543 4 24 4C35.0457 4 44 12.9543 44 24Z"
                    fill="#2F88FF"
                    stroke="black"
                    stroke-width="4"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14 18L32 18"
                    stroke="white"
                    stroke-width="4"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14 26H32"
                    stroke="white"
                    stroke-width="4"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14 34H24"
                    stroke="white"
                    stroke-width="4"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
            </p>
          </div>
          <div
            [ngClass]="
              selectedStyles.includes(item._id || ' ') ? 'block' : 'none'
            "
          >
            <div class="comment" *ngFor="let com of item.comments">
              <b>{{ com.author }}</b>
              <p>{{ com.text }}</p>
            </div>
            <form
              (submit)="addComm(task._id || '', item._id || '', comment.value)"
              class="form-comm"
            >
              <input
                class="input-comm"
                type="text"
                id="comment"
                #comment
              /><button type="submit">&#10010;</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
